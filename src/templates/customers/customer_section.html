{% extends "base.html" %}
{% load static from staticfiles %}

{% block title %}{{ title }}{% endblock title %}

{% block content %}
    <form class="form-modal" id="customer_section" action="{% url 'customer_section' user_id %}" method="post" enctype="multipart/form-data"
          role="form" class="form-horizontal">
        {% csrf_token %}

        <!-- Info Menu -->
        <div class="row margin-top-25">
            <div class="col-md-3">
                <select name="select" id="mydataset" onchange="showDataSets(this)">
                    {% for key, val in data_sets.items %}
                        <option id="{{ val }}" name="{{ key }}" value="{{ val }}" {% if data_set_id == val %}selected="selected"{% endif %}>{{ key }}</option>
                    {% endfor %}
                </select>
            </div>

            {% if dirs_list %}
                <div class="col-md-3">
                    <div class="multiselect select-border-bottom-grey" id="select_root_filenames">
                        <div class="selectBox" onclick="showRootFilenames()">
                            <p class="select-color-grey left">
                                <span>Root-Filenames</span>&nbsp; <span class="right"><i class="fa fa-caret-down select-color-grey right" aria-hidden="true"></i></span>
                            </p>
                            <div class="overSelect"></div>
                        </div>
                        <div id="checkboxes_root_filenames" class="checkboxes">
                            {% for dl in dirs_list%}
                                <label for="{{ dl.id }}" class="left">
                                    <label><input type="checkbox" id="{{ dl.id }}" class="checkboxes_root_filenames" value="{{ dl.id }}" {% if data_set_id == val %}checked="checked"{% endif %}/> <span>{{ dl }}</span></label>
                                </label>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="multiselect select-border-bottom-grey" id="select_statistics">
                        <div class="selectBox" onclick="showStatistics()">
                            <p class="select-color-grey left">
                                <span>Statistics</span>&nbsp; <span class="right"><i class="fa fa-caret-down select-color-grey right" aria-hidden="true"></i></span>
                            </p>
                            <div class="overSelect"></div>
                        </div>
                        <div id="checkboxes_statistics" class="checkboxes">
                            <label for="max" class="left">
                                <label><input type="checkbox" id="max" value="mean_ConditionalMax"/> <span>mean_ConditionalMax</span></label>
                            </label>
                            <label for="mean" class="left">
                                <label><input type="checkbox" id="mean" value="mean_ConditionalMean"/> <span>mean_ConditionalMean</span></label>
                            </label>
                            <label for="median" class="left">
                                <label><input type="checkbox" id="median" value="mean_ConditionalMedian"/> <span>mean_ConditionalMedian</span></label>
                            </label>
                            <label for="min" class="left">
                                <label><input type="checkbox" id="min" value="mean_ConditionalMin"/> <span>mean_ConditionalMin</span>/</label>
                            </label>
                            <label for="qurtile" class="left">
                                <label><input type="checkbox" id="qurtile" value="mean_LowerQurtile"/> <span>mean_LowerQurtile</span></label>
                            </label>
                            <label for="quantile" class="left">
                                <label><input type="checkbox" id="quantile" value="mean_Quantile"/> <span>mean_Quantile</span></label>
                            </label>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="col-md-3">
                <div class="multiselect select-border-bottom-grey" id="select_polygons">
                    <div class="selectBox" onclick="showPolygons()">
                        <p class="select-color-grey left">
                            <span>Polygons</span>&nbsp; <span class="right"><i class="fa fa-caret-down select-color-grey right" aria-hidden="true"></i></span>
                        </p>
                        <div class="overSelect"></div>
                    </div>
                    <div id="checkboxes_polygons" class="checkboxes">
                        {% for polygon in polygons_list%}
                            <label for="{{ polygon }}" class="left">
                                <label><input type="checkbox" id="{{ polygon }}" class="checkboxes_root_filenames" value="{{ polygon }}" {% if data_set_id == val %}checked="checked"{% endif %}/> <span>{{ polygon }}</span></label>
                            </label>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
        <!-- End Info Menu -->

        <!-- Draw Menu -->
        <div class="row margin-top-35">
            <div class="col-md-3 col-md-offset-4 center">
                <button type="button" onclick="removePoligon();"><img src="{% static 'img/map-marker-off.png' %}" alt="hand" title="Remove Poligon"></i></button>
                <button type="button" onclick="drawPoligon();"><img src="{% static 'img/vector-polygon.png' %}" alt="vector polygon" title="Draw a Poligon"></button>
                <button type="button" onclick="togglePlygonOverlays();"><img src="{% static 'img/eye-off.png' %}" alt="hide/show" title="Hide/Show a Poligon"></button>
            </div>


            <div class="col-md-2 left margin-top-5 padding-lr-5">
                <input type="range" id="one" min="0" max="100" onchange="setOpacity(this.value);" alt="transparency" title="Transparency"/>
            </div>
            <div class="col-md-2 left padding-lr-5">
                (transparency)
            </div>
        </div>
        <!-- End Draw Menu -->

        <!-- Google map -->
        <div class="row margin-top-35">
            <div class="col-md-12">
                <div id="map"></div>
            </div>
        </div>
        <!-- End Google map -->

        <!-- GSi LOGO -->
        <div class="row margin-top-35">
            <div class="col-md-12">
                <div class="gsi-logo">
                    <a href="http://www.surfaceintelligence.com/" Target="_blank"><img src="{% static 'img/GSIlogo.png' %}" style="cursor: pointer;"></a>
                </div>
            </div>
        </div>
        <!-- End GSi LOGO -->

        <!-- GSi Info Data -->
        <div class="row">
            <div class="col-md-1 right padding-lr-5">Lat:</div>
            <div class="col-md-3 margin-top-015 padding-left-5 padding-lr-5">
                <input class="form-control placeholder" type="text" id="latitude" readonly>
            </div>
            <div class="col-md-1 right padding-lr-5">Lon:</div>
            <div class="col-md-3 margin-top-015 padding-left-5">
                <input class="form-control placeholder" type="text" id="longitude" readonly>
            </div>

            <div class="col-md-3 margin-top-015 padding-lr-5">
                <input class="form-control placeholder" type="text" id="next" placeholder="data">
            </div>
            <div class="col-md-1 left padding-lr-5">Next:</div>
        </div>
        <!-- End GSi Info Data -->
    </form>

    <script>
        var map;
        var coord = [];
        var markers = [];
        var polygons = [];
        var start_area = {lat: {{ eLat }}, lng: {{ eLng }} };
        var cur_marker;
        var selectPolygon;
        var polugonVisible;
        var mapTypesArr = [];

        var MY_MAPTYPE_ID = 'mystyle';

        var mapobj = {
			name: "OSM",
			wms: "osm",
			minzoom: 18,
			maxzoom: 0,
			url: "http://tile.openstreetmap.org/",
			copy:"<a href=\"http://www.openstreetmap.org\" target=\"_blank\">Open Street Map</a>",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "OSM Cycle",
			wms: "osm",
			minzoom: 18,
			maxzoom: 0,
			url: "http://b.tile.opencyclemap.org/cycle/",
			copy:"<a href=\"http://creativecommons.org/licenses/by-sa/2.0/\">Cycle OSM</a>",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "Relief",
			wms: "",
			minzoom: 18,
			maxzoom: 0,
			url: "",
			copy:"<a href=\"http://www.maps-for-free.com/html/about.html\" target=\"_blank\">maps-for-free</a>",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "Demis",
			wms: "wms",
			minzoom: 13,
			maxzoom: 1,
			url: "http://www2.demis.nl/wms/wms.ashx?Service=WMS&WMS=BlueMarble&Version=1.1.0&Request=GetMap&Layers=Earth Image,Borders,Coastlines&Format=image/jpeg",
			copy:"WMS demo by Demis",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "ROADMAP",
			wms: "",
			minzoom: 13,
			maxzoom: 10,
			url: "",
			copy:"",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "SATELLITE",
			wms: "",
			minzoom: 13,
			maxzoom: 10,
			url: "",
			copy:"",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "HYBRID",
			wms: "",
			minzoom: 13,
			maxzoom: 10,
			url: "",
			copy:"",
			visible:true
		};
		mapTypesArr.push(mapobj);
		var mapobj = {
			name: "TERRAIN",
			wms: "",
			minzoom: 13,
			maxzoom: 10,
			url: "",
			copy:"",
			visible:true
		};
		mapTypesArr.push(mapobj);

        function initMap() {
            var my_styles =  [
                  {
                    featureType: "road.highway",
                    elementType: "geometry",
                    stylers: [
                        { visibility: "on" },
                        { hue: "#ff0000" }
                    ]
                  },
                  {
                      featureType: "water",
                      elementType: "geometry",
                      stylers: [
                          { visibility: "on" },
                          { hue: "#0800ff" },
                          { lightness: -41 }
                    ]
                }
            ];

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: {{ GOOGLE_MAP_ZOOM }},
                center: start_area,
                mapTypeControl: true,
                mapTypeControlOptions: {
                    style: google.maps.MapTypeControlStyle.DROPDOWN_MENU,
                    mapTypeIds: [
                        google.maps.MapTypeId.ROADMAP,
                        google.maps.MapTypeId.TERRAIN,
                        google.maps.MapTypeId.SATELLITE,
                        google.maps.MapTypeId.HYBRID,
                        MY_MAPTYPE_ID
                    ]
                },
                // mapTypeId: MY_MAPTYPE_ID
            });

            var styledMapOptions = {
                name: "Road & Water"
              };

            var jayzMapType = new google.maps.StyledMapType(my_styles, styledMapOptions);

            map.mapTypes.set(MY_MAPTYPE_ID, jayzMapType);
            // map.setMapTypeId(google.maps.MapTypeId.HYBRID);

            cur_marker = new google.maps.Marker({
                position: {
                    'lat':   {{ eLat }},
                    'lng': {{ eLng }}
                },
                map: map
            });

            map.addListener('click', function(e) {
                placeMarkerAndPanTo(e.latLng.lat(), e.latLng.lng());
            });
        }

        function placeMarkerAndPanTo(lat1, lng1) {
            var dict = {
                'lat':   lat1,
                'lng': lng1
            }
            coord.push(dict);

            var marker = new google.maps.Marker({
                position: dict,
                map: map
            });
            //marker.setMap(map);
            //map.panTo(marker);
            markers.push(marker);
        }

        // Removes the poligon from the map, but keeps them in the array.
        function removePoligon() {
            if (polygons) {
                for (i in polygons) {
                    polygons[i].setMap(null);
                }
            }
            coord = [];
            polugonVisible = false;

            // Removes the markers
            removeMarkers();
        }

        // Removes the markers from the map, but keeps them in the array.
        function removeMarkers() {
            // selectPolygon.fillOpacity = 1.0;
            for (var i = 0; i < markers.length; i++) {
                markers[i].setMap(null);
            }
        }

        function drawPoligon() {
            // Construct the polygon.
            selectPolygon = new google.maps.Polygon({
                paths: coord,
                //strokeColor: '#FF0000',
                //strokeOpacity: 0.8,
                strokeWeight: 1,
                fillColor: '#FF0000',
                fillOpacity: 0.3,
                //editable: true
            });
            selectPolygon.setMap(map);
            polygons.push(selectPolygon);
            polugonVisible = true;

            // selectPolygon.fillOpacity = 1.0;

            // Add a listener for the click event.
            selectPolygon.addListener('click', showInfoWindow);
            infoWindow = new google.maps.InfoWindow;

            // Add a listener for the mousemove event.
            selectPolygon.addListener('mousemove', showCoordinates);

            infoWindow = new google.maps.InfoWindow;
        }

        function showCoordinates(event) {
            var lat = event.latLng.lat();
        	var lon = event.latLng.lng();

            document.getElementById('latitude').value = lat.toFixed(6);
            document.getElementById('longitude').value = lon.toFixed(6);
        }

        function showInfoWindow(event) {
            var lat = event.latLng.lat();
        	var lon = event.latLng.lng();

            var contentString = '<b>GSi Polygon</b><br>' +
                'Location:<br>LAT: ' + lat.toFixed(6) + ', LNG:' + lon.toFixed(6) + '<br>';

            // Replace the info window's content and position.
            infoWindow.setContent(contentString);
            infoWindow.setPosition(event.latLng);

            infoWindow.open(map);
        }

        function togglePlygonOverlays() {
            if (polugonVisible) {
                selectPolygon.setMap(null);
                polugonVisible = false;
            } else {
                selectPolygon.setMap(map);
                polugonVisible = true;
            }
        }


    </script>

    <script type="text/javascript" async defer
        src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB4HosogGf9o2-Cnef_SiUR6jZYVszGkGY&signed_in=true&callback=initMap"></script>
{% endblock content %}
